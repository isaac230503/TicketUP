<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>TicketUP ‚Äî Meus Pedidos</title>
  <link rel="stylesheet" href="index.css">

  <style>
    .orders-list { 
      max-width:1100px; 
      margin:24px auto; 
      padding:0 12px;
    }

    .order-row {
      background:#fff;
      padding:16px;
      margin-bottom:12px;
      border-radius:8px;
      border:1px solid #ddd;
    }

    .order-header {
      display:flex;
      justify-content:space-between;
      margin-bottom:10px;
      font-weight:600;
    }

    .order-item {
      display:flex;
      justify-content:space-between;
      padding:4px 0;
      border-bottom:1px solid #eee;
      font-size:14px;
    }

    .order-empty {
      text-align:center;
      padding:36px;
      color:#666;
      font-size:16px;
    }
  </style>
</head>
<body>

  <header class="topbar">
    <div class="topbar-inner container">

      <a href="index.html">
        <img src="../assets/logo.png" alt="TicketUP" style="height:48px">
      </a>

      <nav class="toplinks">
        <a href="index.html">In√≠cio</a>
        <a href="ajuda.html">Central de Ajuda</a>
      </nav>

    </div>
  </header>

  <main>
    <h1 style="max-width:1100px;margin:24px auto;padding:0 12px;">Meus Pedidos</h1>

    <section id="orders-list" class="orders-list"></section>
  </main>

  <footer style="margin-top:40px;padding:20px;text-align:center;color:#999;">
    ¬© 2025 TicketUP ‚Äî Todos os direitos reservados
  </footer>

  <script>
  // ===============================
  // üìå Obter token
  // ===============================
  function getToken() {
    return localStorage.getItem("token");
  }

  let TICKETS_CACHE = {};

  // ===============================
  // üìå Carregar tickets do data.json
  // ===============================
  async function loadTickets() {
    try {
      const res = await fetch("/data.json");
      const json = await res.json();
      json.tickets.forEach(t => {
        TICKETS_CACHE[t.id] = t;
      });
    } catch (e) {
      console.warn("Erro carregando tickets:", e);
    }
  }

  // ===============================
  // üìå Carregar pedidos do usu√°rio
  // ===============================
  async function loadMyOrders() {
    const token = getToken();
    const container = document.querySelector(".orders-list");

    if (!container) return;

    if (!token) {
      container.innerHTML = `
        <p class="order-empty">Voc√™ precisa estar logado para ver seus pedidos.</p>
      `;
      return;
    }

    await loadTickets();

    try {
      const res = await fetch("/api/orders", {
        headers: { "Authorization": "Bearer " + token }
      });

      if (!res.ok) {
        container.innerHTML = `<p class="order-empty">‚ùå Erro ao carregar pedidos.</p>`;
        return;
      }

      const orders = await res.json();

      if (!orders.length) {
        container.innerHTML = `<p class="order-empty">Voc√™ ainda n√£o fez nenhum pedido.</p>`;
        return;
      }

      container.innerHTML = "";

      orders.forEach(o => {
        let itensHTML = o.items.map(i => {
          let t = TICKETS_CACHE[i.ticket_id];

          if (!t) {
            return `<div class="order-item">Ingresso desconhecido (ID ${i.ticket_id})</div>`;
          }

          return `
            <div class="order-item">
              <span>${t.name} ‚Äî ${i.qty}x</span>
              <strong>R$ ${((t.price_cents * i.qty) / 100).toFixed(2).replace(".", ",")}</strong>
            </div>`;
        }).join("");

        container.innerHTML += `
          <div class="order-row">
            <div class="order-header">
              <div>Pedido: <strong>${o.code}</strong></div>
              <div>${new Date(o.created_at).toLocaleString("pt-BR")}</div>
            </div>

            ${itensHTML}

            <div style="text-align:right;margin-top:10px;">
              <strong>Total: R$ ${(o.total_cents / 100).toFixed(2).replace(".", ",")}</strong>
            </div>
          </div>`;
      });

    } catch (err) {
      console.error("Erro:", err);
      container.innerHTML = `<p class="order-empty">Erro ao conectar ao servidor.</p>`;
    }
  }

  document.addEventListener("DOMContentLoaded", loadMyOrders);
</script>



</body>
</html>
